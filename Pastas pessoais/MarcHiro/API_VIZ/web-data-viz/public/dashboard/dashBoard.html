<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vitalis | DASHBOARD</title>
  <link rel="stylesheet" href="../assets/style/style.css">
  <link rel="stylesheet" href="../assets/style/dashboard.css">
      <script src="../js/sessao.js"></script>
    <!-- <script src="./../js/alerta.js"></script> -->

    <link rel="preconnect" href="https://fonts.gstatic.com">
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://kit.fontawesome.com/9f7414eb10.js" crossorigin="anonymous"></script>
</head>

<body>

  <div class="header">
    <div class="container">
      <div class="logo">
        <img class="icon" src="../assets/icon/icon_leaf.png" />
        <h1 class="titulo">Vitalis</h1>
      </div>

      <ul class="navbar">
        <li>
          <a href="../index.html">HOME</a>
        </li>

        <li>
          <a href="../pagCalculadora.html">SIMULADOR</a>
        </li>

        <li class="campo" style="width: 150px;">
          <a style="width: 150px;" href="../PaginaPerfil.html">
            <div style="width: 100%; display: flex;justify-content: center; align-items: center;"><span>MEU
                PERFIL</span><img alt="perfil" src="../assets/icon/icon_person.png"></div>
          </a>
        </li>

      </ul>
    </div>
  </div>


    <div class="janela">
        <div class="header-left">
            <h1>AquaTech</h1>

            <div class="hello">
                <h3>Olá, <span id="b_usuario">usuário</span>!</h3>
            </div>

            <div class="btn-nav-white">
                <a href="./cards.html">
                    <h3>Aquários</h3>
                </a>
            </div>

            <div class="btn-nav">

                <h3>Gráficos</h3>

            </div>

            <div class="btn-nav-white">
                <a href="./mural.html">
                    <h3>Mural de Avisos</h3>
                </a>
            </div>

            <div class="btn-logout" onclick="limparSessao()">
                <h3>Sair</h3>
            </div>

        </div>

        <div class="dash">
            <div id="alerta">
            </div>

            <div class="btns-dash" id="btnPlantacao">
                <!-- O gráfico é chamado de acordo com o id (fk_Plantacao) do banco  -->
            </div>
            <div id="graficos">
            </div>
        </div>
    </div>


  <div class="footer">
    <div class="container">
      <div class="left_container">
        <h4>Soluções inteligentes para o agronegócio</h4>
        <div class="contacts_container">
          <img src="../assets/icon/instagran.png" alt="Instagram" />
          <img src="../assets/icon/whatzapp.png" alt="WhatsApp" />
          <img src="../assets/icon/facebook.png" alt="Facebook" />
        </div>
      </div>

      <div class="right_container">
        <div class="left">
          <h6>Explore</h6>
          <p>Home</p>
          <p>Sobre Nós</p>
          <p>Equipe</p>
        </div>

        <div class="vertical_ruler">
          <hr />
        </div>

        <div class="right">
          <div class="above">
            <h6>Endereço</h6>
            <p>
              Rua Haddock Lobo 595<br />
              São Paulo, SP<br />
              01414-905
            </p>
          </div>

          <div class="bellow">
            <h6>Contato</h6>
            <p>vitaliscaju@gmail.com</p>
            <p>+55 11 4002-8922</p>
          </div>
        </div>
      </div>
    </div>

    <div class="midPlantacaodle">
      <hr />
    </div>

    <div class="page_end">
      <p>© 2025 Vitalis. Todos os direitos reservados.</p>
      <p>Política de PrivacidPlantacaoade</p>
    </div>
  </div>


</body>

</html>

<script>
    b_usuario.innerHTML = sessionStorage.NOME_USUARIO;

    let proximaAtualizacao;

    window.onload = exibirPlantacoesDoUsuario();

    function exibirPlantacoesDoUsuario() 
    {
        var Plantacoes = JSON.parse(sessionStorage.plantacoes);
        Plantacoes.forEach(item => {
            document.getElementById("btnPlantacao").innerHTML += `
            <button class="btn-chart" onclick="exibirPlantacao(${item.idPlantacao})" id="btnPlantacao${item.idPlantacao}">${item.AreaM2}</button>
            `

            document.getElementById("graficos").innerHTML += `
                <div id="grafico${item.idPlantacao}" class="display-none">
                    <h3 class="tituloGraficos">
                        <span id="tituloPlantacao${item.idPlantacao}">${item.AreaM2}</span>
                    </h3>
                    <div class="graph">
                        <canvas id="myChartCanvas${item.idPlantacao}"></canvas>
                    </div>
                    <div class="label-captura">
                        <p id="avisoCaptura${item.idPlantacao}" style="color: white"></p>
                    </div>
                </div>
            `

            obterDadosGrafico(item.idPlantacao)
        });

        if (Plantacoes.length > 0) {
            exibirPlantacao(Plantacoes[0].idPlantacao)
        }
    }

    function alterarTitulo(idPlantacao) {
        var tituloPlantacao = document.getElementById(`tituloPlantacao${idPlantacao}`)
        // var AreaM2 = JSON.parse(sessionStorage.plantacoes).find(item => item.idPlantacao == idPlantacao).AreaM2;
        // tituloPlantacao.innerHTML = "Últimas medidas de Umidade do <span style='color: #e6005a'>" + AreaM2 + "</span>"
    }
    function exibirPlantacao(idPlantacao) {
        let todosOsGraficos = JSON.parse(sessionStorage.plantacoes);

        for (i = 0; i < todosOsGraficos.length; i++) {
            // exibindo - ou não - o gráfico
            if (todosOsGraficos[i].idPlantacao != idPlantacao) {
                let elementoAtual = document.getElementById(`grafico${todosOsGraficos[i].idPlantacao}`)
                if (elementoAtual.classList.contains("display-block")) {
                    elementoAtual.classList.remove("display-block")
                }
                elementoAtual.classList.add("display-none")

                // alterando estilo do botão
                let btnAtual = document.getElementById(`btnPlantacao${todosOsGraficos[i].idPlantacao}`)
                if (btnAtual.classList.contains("btn-pink")) {
                    btnAtual.classList.remove("btn-pink")
                }
                btnAtual.classList.add("btn-white")
            }
        }

        // exibindo - ou não - o gráfico
        let graficoExibir = document.getElementById(`grafico${idPlantacao}`)
        graficoExibir.classList.remove("display-none")
        graficoExibir.classList.add("display-block")

        // alterando estilo do botão
        let btnExibir = document.getElementById(`btnPlantacao${idPlantacao}`)
        btnExibir.classList.remove("btn-white")
        btnExibir.classList.add("btn-pink")
    }

    // O gráfico é construído com três funções:
    // 1. obterDadosGrafico -> Traz dados do Banco de Dados para montar o gráfico da primeira vez

    // 2. plotarGrafico -> Monta o gráfico com os dados trazidPlantacaoos e exibe em tela

    // 3. atualizarGrafico -> Atualiza o gráfico, trazendo novamente dados do Banco

    // Esta função *obterDadosGrafico* busca os últimos dados inseridPlantacaoos em tabela de medidas.
    // para, quando carregar o gráfico da primeira vez, já trazer com vários dados.
    // A função *obterDadosGrafico* também invoca a função *plotarGrafico*

    //     Se quiser alterar a busca, ajuste as regras de negócio em src/controllers
    //     Para ajustar o "select", ajuste o comando sql em src/models



    function obterDadosGrafico(idPlantacao) {

        alterarTitulo(idPlantacao)

        if (proximaAtualizacao != undefined) {
            clearTimeout(proximaAtualizacao);
        }

        fetch(`/medidas/ultimas/${idPlantacao}`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resposta) {
                    console.log(`Dados recebi Plantacaoos: ${JSON.stringify(resposta)}`);
                    console.log(resposta);
                    resposta.reverse();

                    plotarGrafico(resposta, idPlantacao);

                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });
    }

    // Esta função *plotarGrafico* usa os dados capturados na função anterior para criar o gráfico
    // Configura o gráfico (cores, tipo, etc), materializa-o na página e, 
    // A função *plotarGrafico* também invoca a função *atualizarGrafico*


    function plotarGrafico(resposta, idPlantacao) {

        console.log('iniciando plotagem do gráfico...');

        // Criando estrutura para plotar gráfico - labels
        let labels = [];

        // Criando estrutura para plotar gráfico - dados
        let dados = {
            labels: labels,
            datasets: [{
                label: 'umidade',
                data: [],
                fill: false,
                borderColor: 'rgb(75, 192, 192)',
                tension: 0.1
            }]
        };

        console.log('----------------------------------------------')
        console.log('Estes dados foram recebidPlantacaoos pela funcao "obterDadosGrafico" e passados para "plotarGrafico":')
        console.log(resposta)

        // Inserindo valores recebidPlantacaoos em estrutura para plotar o gráfico
        for (i = 0; i < resposta.length; i++) {
            var registro = resposta[i];
            labels.push(registro.momento);
            dados.datasets[0].data.push(registro.umidade);

        }

        console.log('----------------------------------------------')
        console.log('O gráfico será plotado com os respectivos valores:')
        console.log('Labels:')
        console.log(labels)
        console.log('Dados:')
        console.log(dados.datasets)
        console.log('----------------------------------------------')

        // Criando estrutura para plotar gráfico - config
        const config = {
            type: 'line',
            data: dados,
        };

        // Adicionando gráfico criado em div na tela
        let myChart = new Chart(
            document.getElementById(`myChartCanvas${idPlantacao}`),
            config
        );

        setTimeout(() => atualizarGrafico(idPlantacao, dados, myChart), 2000);
    }






    function atualizarGrafico(idPlantacao, dados, myChart) {



        fetch(`/medidas/tempo-real/${idPlantacao}/`, { cache: 'no-store' }).then(function (response) {
            if (response.ok) {
                response.json().then(function (resultado) {

                    // obterDadosGrafico(idPlantacao);

                    console.log(`Dados recebidPlantacaoos: ${JSON.stringify(resultado)}`);
                    console.log(`Dados atuais do gráfico:`);
                    // console.log(dados);

                    if (resultado[0].momento == dados.labels[dados.labels.length - 1]) {
                        console.log("---------------------------------------------------------------")
                        console.log("Como não há dados novos para captura, o gráfico não atualizará.")
                        // avisoCaptura.innerHTML = "<i class='fa-solidPlantacao fa-triangle-exclamation'></i> Foi trazido Plantacaoo o dado mais atual capturado pelo sensor. <br> Como não há dados novos a exibir, o gráfico não atualizará."
                        console.log("Horário do novo dado capturado:")
                        console.log(resultado[0].momento)
                        console.log("Horário do último dado capturado:")
                        // console.log(dados.labels[dados.labels.length - 1])
                        // console.log("---------------------------------------------------------------")
                    } else {
                        // tirando e colocando valores no gráfico
                        dados.labels.shift(); // apagar o primeiro
                        dados.labels.push(resultado[0].momento); // incluir um novo momento

                        dados.datasets[0].data.shift();  // apagar o primeiro de Umidade
                        dados.datasets[0].data.push(resultado[0].umidade); // incluir uma nova medidPlantacaoa de Umidade

                        myChart.update();
                    }

                    // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápidPlantacaoo ou mais devagar
                    proximaAtualizacao = setTimeout(() => atualizarGrafico(idPlantacao, dados, myChart), 2000);
                });
            } else {
                console.error('Nenhum dado encontrado ou erro na API');
                // Altere aqui o valor em ms se quiser que o gráfico atualize mais rápidPlantacaoo ou mais devagar
                proximaAtualizacao = setTimeout(() => atualizarGrafico(idPlantacao, dados, myChart), 2000);
            }
        })
            .catch(function (error) {
                console.error(`Erro na obtenção dos dados p/ gráfico: ${error.message}`);
            });

    }


</script>